---
layout: post
title: カスタムディレクティブ
date: 2016-01-16 00:00:00
---

## まえがき

『AngularJSリファレンス』(池添明宏、金井健一、吉田徹生[共著])を読んでいます。

ここでは「Chapter 10 カスタムディレクティブ」についてまとめてみたいと思います。

カスタムディレクティブの登録・利用方法については省略します。

## AngularJSの仕組み

HTMLを読み込むときに、次のような処理を実行するようです。

1. HTMLをパースして、ディレクティブを利用しているところを見つける
1. ディレクティブのcompile関数を呼び出す
1. ディレクティブのlink関数を呼び出す
1. $digestループを実行する

$digestループは双方向バインディングを支える仕組みです。

## $digestループの実行タイミング

HTMLを読み込むとき以外にも、次のようなときに$digestループが実行されます。

- ブラウザのイベントが発生したとき
- $scope.$applyが呼ばれたとき
  - $applyの引数が文字列
  - $applyの引数が関数

## $scope.$apply

$scope.$applyはスコープオブジェクトのプロパティを更新するために利用します。

引数が文字列のときは、その文字列を実行して、$scopeのプロパティを更新します。

引数が関数のときは、その関数を$asyncQueueに登録して、$digestループの中で実行します。

## $digestループの仕組み

$digestループでは、次のような処理を実行するようです。

- $asyncQueueに登録されている関数を実行して、$scopeのプロパティを更新する
- $watchersに登録されているwatch式を実行する
- watch式の結果が前回の結果と違うときはリスナーを実行して、DOMを更新する
  - 全watch式の結果が前回の結果と同じときに$digestループを終了する
  - それ以外のときは$digestループが再度実行される

## ディレクティブで指定可能なプロパティ

次のようなプロパティがあります。

- name
- template
- templateUrl
- restrict
- scope
- replace
- transclude
- multiElement
- compile
- link
- priority
- terminal
- controller
- controllerAs
- require

### name

ディレクティブの名前を指定する。string型。

### template

テンプレートHTMLの内容を指定する。string型。

### templateUrl

テンプレートHTMLファイルのパスを指定する。string型。

### restrict

ディレクティブの適用方法を指定する。string型。

### scope

スコープの生成方法を指定する。boolean型またはObject型。

falseのとき、ディレクティブを適用した箇所のスコープになる。

ng-controllerを指定したタグの中では、そのコントローラのスコープになる。

trueのとき、ディレクティブを適用した箇所のスコープの派生スコープになる。

ng-controllerを指定したタグの中では、そのコントローラのスコープの派生スコープになる。

オブジェクトリテラルのとき、独立したスコープになる。

独立したスコープオブジェクトのプロパティとディレクティブの属性の値を紐付ける仕組みがある。

'=', '@', '&'を使って紐付ける。これらの記号の後にディレクティブの属性名を続ける。プロパティ名とその属性名が同じときはその属性名を省略できる。

'='のとき、データバインディングとして紐付ける。

'@'のとき、文字列として紐付ける。

'&'のとき、関数として紐付ける。

独立したスコープの範囲は、ディレクティブを指定したタグの中だと思う。

### replace

ディレクティブを適用したタグをテンプレートと置き換えるかを指定する。boolean型。

デフォルトはfalse。

falseのとき、テンプレートはディレクティブを適用したタグの子要素に展開される。

trueのとき、ディレクティブを適用したタグそのものをテンプレートと置き換える。

### transclude

子要素の利用方法を指定する。boolean型。

falseのとき、ディレクティブを指定したタグの子要素はなくなる。

trueのとき、ディレクティブを指定したタグの子要素はテンプレートのng-transcludeを指定したタグの子要素に展開される。

compile関数やlink関数の引数で関数として受け取ることもできる。

### multiElement

理解できていません。

### compile

compile関数を指定する。Function型。

第1引数はディレクティブを適用したタグ。

第2引数はディレクティブを適用したタグの属性。

第3引数はディレクティブの子要素を展開する関数。

### link

link関数を指定する。Function型またはObject型。

第1引数はスコープオブジェクト。

第2引数はディレクティブを適用したタグ。

第3引数はディレクティブを適用したタグの属性。

第4引数はコントローラオブジェクト。(理解できていません)

第5引数はディレクティブの子要素を展開する関数。

Object型のときはプロパティにpre, postを用意して、前処理、後処理を用意することができる。

compile関数, link関数の両方を指定するとlink関数は実行されない。

compile関数, link関数の両方を用意したいときはcompile関数の戻り値にlink関数を返す。

### priority

理解できていません。

### terminal

理解できていません。

### controller

コントローラを指定する。Function型。

### controllerAs

コントローラの別名を指定する。string型。

### require

依存するディレクティブを指定する。string型またはArray型。

## あとがき

駆け足でAngularJSの仕組みと$digestループの仕組みを確認して、ディレクティブのプロパティを確認しました。

requireプロパティで依存するディレクティブを指定したとき、link関数の第4引数にそのディレクティブのcontrollerが渡るようですが、この辺はまだ理解できていません。

一方、スコープについては深く理解できたと思います。
